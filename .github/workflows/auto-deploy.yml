name: Auto Deploy on Push

on:
  push:
    branches:
      - master
    paths-ignore:
      - "**.md"
      - "docs/**"

jobs:
  auto-deploy:
    runs-on: ubuntu-latest
    name: Auto Deploy to Ccolify
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: master
          fetch-depth: 0

      - name: Create deployment tag
        run: |
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          TAG_NAME="auto-deploy-${TIMESTAMP}"
          git tag -a "${TAG_NAME}" -m "Auto deployment triggered on push"
          git push origin "${TAG_NAME}"

      - name: Trigger Docker Build
        run: |
          echo "Deployment triggered successfully"
          echo "Docker images will be built from the latest master branch"
          echo "Changes will be reflected in your Ccolify deployment"

  build-notification:
    needs: auto-deploy
    runs-on: ubuntu-latest
    name: Notify Deployment
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get commit info
        id: commit
        run: |
          echo "commit_sha=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
          echo "commit_message=$(git log -1 --pretty=%B)" >> $GITHUB_OUTPUT
          echo "commit_author=$(git log -1 --pretty=%an)" >> $GITHUB_OUTPUT

      - name: Deployment Summary
        run: |
          echo "âœ… Deployment Started"
          echo "Commit: ${{ steps.commit.outputs.commit_sha }}"
          echo "Author: ${{ steps.commit.outputs.commit_author }}"
          echo "Message: ${{ steps.commit.outputs.commit_message }}"
          echo ""
          echo "Your changes will be deployed automatically:"
          echo "1. Docker images will be built from your local source"
          echo "2. Dockerfiles use 'pip install -e .[core]' for development mode"
          echo "3. All your latest code changes will be included"
