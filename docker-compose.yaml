version: '3.8'

# Root-level docker-compose for MinerU
# - Builds images from docker/global (or docker/china) Dockerfiles
# - Provides three services: mineru-vllm-server (30000), mineru-api (8000), mineru-gradio (7860)
# - Uses Docker GPU device_requests (via 'deploy') to expose NVIDIA GPUs to containers
# - Persists downloaded models and user outputs to host volumes

services:
  mineru-vllm-server:
    build:
      context: ./docker/global
      dockerfile: Dockerfile
    image: mineru-vllm:local
    container_name: mineru-vllm-server
    restart: unless-stopped

    environment:
      MINERU_MODEL_SOURCE: local
    entrypoint: ["mineru-vllm-server"]
    command: ["--host", "0.0.0.0", "--port", "30000"]
    volumes:
      - ./models:/root/.cache/mineru_models
      - ./output:/workspace/output
    # ------------------------------------------------------------------
    # ✅ GPU-Konfiguration hinzugefügt
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]
    # ------------------------------------------------------------------

  mineru-api:
    build:
      context: ./docker/global
      dockerfile: Dockerfile
    image: mineru-api:local
    container_name: mineru-api
    restart: unless-stopped

    environment:
      MINERU_MODEL_SOURCE: local
    entrypoint: ["mineru-api"]
    command: ["--host", "0.0.0.0", "--port", "8000"]
    volumes:
      - ./models:/root/.cache/mineru_models
      - ./output:/workspace/output
    # ------------------------------------------------------------------
    # ✅ GPU-Konfiguration hinzugefügt
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]
    # ------------------------------------------------------------------

  mineru-gradio:
    build:
      context: ./docker/global
      dockerfile: Dockerfile
    image: mineru-gradio:local
    container_name: mineru-gradio
    restart: unless-stopped

    environment:
      MINERU_MODEL_SOURCE: local
    entrypoint: ["mineru-gradio"]
    command: ["--server-name", "0.0.0.0", "--server-port", "7860", "--enable-vllm-engine", "true"]
    volumes:
      - ./models:/root/.cache/mineru_models
      - ./output:/workspace/output
    # ------------------------------------------------------------------
    # ✅ GPU-Konfiguration hinzugefügt
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]
    # ------------------------------------------------------------------